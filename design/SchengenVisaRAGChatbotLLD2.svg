<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2208px" preserveAspectRatio="none" style="width:4108px;height:2208px;" version="1.1" viewBox="0 0 4108 2208" width="4108px" zoomAndPan="magnify"><defs><filter height="300%" id="fqa89q5t8z60i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[84718776d214be480e4c259efcb737fc]
class Main--><rect codeLine="4" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="88.652" id="Main" style="stroke:#A80036;stroke-width:1.5;" width="91" x="1470.43" y="52"/><ellipse cx="1492.18" cy="73.3441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1495.1488,78.9847 Q1494.5706,79.2816 1493.93,79.4222 Q1493.2894,79.5785 1492.5863,79.5785 Q1490.0863,79.5785 1488.7581,77.9379 Q1487.4456,76.2816 1487.4456,73.1566 Q1487.4456,70.0316 1488.7581,68.3754 Q1490.0863,66.7191 1492.5863,66.7191 Q1493.2894,66.7191 1493.93,66.8754 Q1494.5863,67.0316 1495.1488,67.3285 L1495.1488,70.0472 Q1494.5238,69.4691 1493.93,69.2035 Q1493.3363,68.9222 1492.7113,68.9222 Q1491.3675,68.9222 1490.68,70.0004 Q1489.9925,71.0629 1489.9925,73.1566 Q1489.9925,75.2504 1490.68,76.3285 Q1491.3675,77.391 1492.7113,77.391 Q1493.3363,77.391 1493.93,77.1254 Q1494.5238,76.8441 1495.1488,76.266 L1495.1488,78.9847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="42" x="1508.68" y="69.8281">«Script»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="44" x="1507.68" y="86.1722">main.py</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1471.43" x2="1560.43" y1="94.6882" y2="94.6882"/><ellipse cx="1481.43" cy="105.6882" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="65" x="1490.43" y="110.4471">app: FastAPI</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1471.43" x2="1560.43" y1="117.6701" y2="117.6701"/><ellipse cx="1481.43" cy="128.6701" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="30" x="1490.43" y="133.429">start()</text><!--MD5=[565c9d1efa1b007c17737c6b0effd1e0]
class Routes--><rect codeLine="9" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="88.652" id="Routes" style="stroke:#A80036;stroke-width:1.5;" width="322" x="1354.93" y="265"/><ellipse cx="1485.68" cy="286.3441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1488.6488,291.9847 Q1488.0706,292.2816 1487.43,292.4222 Q1486.7894,292.5785 1486.0863,292.5785 Q1483.5863,292.5785 1482.2581,290.9379 Q1480.9456,289.2816 1480.9456,286.1566 Q1480.9456,283.0316 1482.2581,281.3754 Q1483.5863,279.7191 1486.0863,279.7191 Q1486.7894,279.7191 1487.43,279.8754 Q1488.0863,280.0316 1488.6488,280.3285 L1488.6488,283.0472 Q1488.0238,282.4691 1487.43,282.2035 Q1486.8363,281.9222 1486.2113,281.9222 Q1484.8675,281.9222 1484.18,283.0004 Q1483.4925,284.0629 1483.4925,286.1566 Q1483.4925,288.2504 1484.18,289.3285 Q1484.8675,290.391 1486.2113,290.391 Q1486.8363,290.391 1487.43,290.1254 Q1488.0238,289.8441 1488.6488,289.266 L1488.6488,291.9847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="52" x="1506.18" y="282.8281">«Module»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="52" x="1506.18" y="299.1722">routes.py</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1355.93" x2="1675.93" y1="307.6882" y2="307.6882"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1355.93" x2="1675.93" y1="315.6882" y2="315.6882"/><ellipse cx="1365.93" cy="326.6882" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="296" x="1374.93" y="331.4471">websocket_endpoint(websocket: WebSocket, user_id: str)</text><ellipse cx="1365.93" cy="341.6701" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="108" x="1374.93" y="346.429">health_check() -&gt; dict</text><!--MD5=[c9eb61b967b7027d644f7ee84d5486fc]
class Dependencies--><rect codeLine="14" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="103.6339" id="Dependencies" style="stroke:#A80036;stroke-width:1.5;" width="267" x="1382.43" y="433"/><ellipse cx="1464.68" cy="454.3441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1467.6488,459.9847 Q1467.0706,460.2816 1466.43,460.4222 Q1465.7894,460.5785 1465.0863,460.5785 Q1462.5863,460.5785 1461.2581,458.9379 Q1459.9456,457.2816 1459.9456,454.1566 Q1459.9456,451.0316 1461.2581,449.3754 Q1462.5863,447.7191 1465.0863,447.7191 Q1465.7894,447.7191 1466.43,447.8754 Q1467.0863,448.0316 1467.6488,448.3285 L1467.6488,451.0472 Q1467.0238,450.4691 1466.43,450.2035 Q1465.8363,449.9222 1465.2113,449.9222 Q1463.8675,449.9222 1463.18,451.0004 Q1462.4925,452.0629 1462.4925,454.1566 Q1462.4925,456.2504 1463.18,457.3285 Q1463.8675,458.391 1465.2113,458.391 Q1465.8363,458.391 1466.43,458.1254 Q1467.0238,457.8441 1467.6488,457.266 L1467.6488,459.9847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="52" x="1506.18" y="450.8281">«Module»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94" x="1485.18" y="467.1722">dependencies.py</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1383.43" x2="1648.43" y1="475.6882" y2="475.6882"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1383.43" x2="1648.43" y1="483.6882" y2="483.6882"/><ellipse cx="1393.43" cy="494.6882" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="241" x="1402.43" y="499.4471">get_response_manager() -&gt; ResponseManager</text><ellipse cx="1393.43" cy="509.6701" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="210" x="1402.43" y="514.429">get_vector_retriever() -&gt; VectorRetriever</text><ellipse cx="1393.43" cy="524.652" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="221" x="1402.43" y="529.4109">get_llm_orchestrator() -&gt; LLMOrchestrator</text><!--MD5=[092fa08d85cd03567cff8db24520f3b2]
class ResponseManager--><rect codeLine="20" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="362.6196" id="ResponseManager" style="stroke:#A80036;stroke-width:1.5;" width="1238" x="1246.93" y="616"/><ellipse cx="1809.18" cy="632" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1812.1488,637.6406 Q1811.5706,637.9375 1810.93,638.0781 Q1810.2894,638.2344 1809.5863,638.2344 Q1807.0863,638.2344 1805.7581,636.5938 Q1804.4456,634.9375 1804.4456,631.8125 Q1804.4456,628.6875 1805.7581,627.0313 Q1807.0863,625.375 1809.5863,625.375 Q1810.2894,625.375 1810.93,625.5313 Q1811.5863,625.6875 1812.1488,625.9844 L1812.1488,628.7031 Q1811.5238,628.125 1810.93,627.8594 Q1810.3363,627.5781 1809.7113,627.5781 Q1808.3675,627.5781 1807.68,628.6563 Q1806.9925,629.7188 1806.9925,631.8125 Q1806.9925,633.9063 1807.68,634.9844 Q1808.3675,636.0469 1809.7113,636.0469 Q1810.3363,636.0469 1810.93,635.7813 Q1811.5238,635.5 1812.1488,634.9219 L1812.1488,637.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="105" x="1829.68" y="636.656">ResponseManager</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1247.93" x2="2483.93" y1="648" y2="648"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="656"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="118" x="1266.93" y="663.7589">websocket: WebSocket</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="670.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="172" x="1266.93" y="678.7408">vector_retriever: VectorRetriever</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="685.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="183" x="1266.93" y="693.7227">llm_orchestrator: LLMOrchestrator</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="700.9457"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="194" x="1266.93" y="708.7046">confidence_scorer: ConfidenceScorer</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="715.9276"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="229" x="1266.93" y="723.6865">clarification_manager: ClarificationManager</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="730.9094"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="243" x="1266.93" y="738.6684">conversation_manager: ConversationManager</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1247.93" x2="2483.93" y1="745.8913" y2="745.8913"/><ellipse cx="1257.93" cy="756.8913" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="1212" x="1266.93" y="761.6502">__init__(websocket: WebSocket, vector_retriever: VectorRetriever, llm_orchestrator: LLMOrchestrator, confidence_scorer: ConfidenceScorer, clarification_manager: ClarificationManager, conversation_manager: ConversationManager)</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="776.6321"/><ellipse cx="1257.93" cy="786.8551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="338" x="1266.93" y="791.614">handle_query(user_id: str, query: str, is_logged_in: bool) -&gt; None</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="806.5959"/><ellipse cx="1257.93" cy="816.8189" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="329" x="1266.93" y="821.5778">process_rag_pipeline(query: str) -&gt; tuple[str, ConfidenceResult]</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="836.5597"/><ellipse cx="1257.93" cy="846.7827" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="196" x="1266.93" y="851.5416">send_response(response: str) -&gt; None</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="866.5235"/><ellipse cx="1257.93" cy="876.7464" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="246" x="1266.93" y="881.5053">send_clarifying_question(question: str) -&gt; None</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="896.4872"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="903.7102"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="262" x="1266.93" y="911.4691">retrieve_context(query: str) -&gt; List[RetrievalResult]</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="926.451"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="933.674"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="342" x="1266.93" y="941.4329">generate_response(query: str, context: List[RetrievalResult]) -&gt; str</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1269.93" y="956.4148"/><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1254.93" y="963.6378"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="499" x="1266.93" y="971.3967">evaluate_confidence(query: str, context: List[RetrievalResult], response: str) -&gt; ConfidenceResult</text><!--MD5=[e419a5ee4a43380e297bb8c092df1f9b]
class VectorRetriever--><rect codeLine="98" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="152.8732" id="VectorRetriever" style="stroke:#A80036;stroke-width:1.5;" width="519" x="467.43" y="1080.5"/><ellipse cx="679.18" cy="1096.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M682.1488,1102.1406 Q681.5706,1102.4375 680.93,1102.5781 Q680.2894,1102.7344 679.5863,1102.7344 Q677.0863,1102.7344 675.7581,1101.0938 Q674.4456,1099.4375 674.4456,1096.3125 Q674.4456,1093.1875 675.7581,1091.5313 Q677.0863,1089.875 679.5863,1089.875 Q680.2894,1089.875 680.93,1090.0313 Q681.5863,1090.1875 682.1488,1090.4844 L682.1488,1093.2031 Q681.5238,1092.625 680.93,1092.3594 Q680.3363,1092.0781 679.7113,1092.0781 Q678.3675,1092.0781 677.68,1093.1563 Q676.9925,1094.2188 676.9925,1096.3125 Q676.9925,1098.4063 677.68,1099.4844 Q678.3675,1100.5469 679.7113,1100.5469 Q680.3363,1100.5469 680.93,1100.2813 Q681.5238,1100 682.1488,1099.4219 L682.1488,1102.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87" x="699.68" y="1101.156">VectorRetriever</text><line style="stroke:#A80036;stroke-width:1.5;" x1="468.43" x2="985.43" y1="1112.5" y2="1112.5"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="475.43" y="1120.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="121" x="487.43" y="1128.2589">client: ChromaDBClient</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="475.43" y="1135.4819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="104" x="487.43" y="1143.2408">collection_name: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="475.43" y="1150.4638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="49" x="487.43" y="1158.2227">top_k: int</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="475.43" y="1165.4457"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="100" x="487.43" y="1173.2046">reranker: Reranker</text><line style="stroke:#A80036;stroke-width:1.5;" x1="468.43" x2="985.43" y1="1180.4276" y2="1180.4276"/><ellipse cx="478.43" cy="1191.4276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="493" x="487.43" y="1196.1865">__init__(client: ChromaDBClient, collection_name: str, top_k: int = 3, reranker: Reranker = None)</text><ellipse cx="478.43" cy="1206.4094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="218" x="487.43" y="1211.1684">retrieve(query: str) -&gt; List[RetrievalResult]</text><ellipse cx="478.43" cy="1221.3913" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="393" x="487.43" y="1226.1502">retrieve_with_reranking(query: str, initial_k: int = 10) -&gt; List[RetrievalResult]</text><!--MD5=[d6e4209ec322f45f940c8827354c6993]
class ChromaDBClient--><rect codeLine="108" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="122.9094" id="ChromaDBClient" style="stroke:#A80036;stroke-width:1.5;" width="433" x="570.43" y="1387.5"/><ellipse cx="735.68" cy="1403.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M738.6488,1409.1406 Q738.0706,1409.4375 737.43,1409.5781 Q736.7894,1409.7344 736.0863,1409.7344 Q733.5863,1409.7344 732.2581,1408.0938 Q730.9456,1406.4375 730.9456,1403.3125 Q730.9456,1400.1875 732.2581,1398.5313 Q733.5863,1396.875 736.0863,1396.875 Q736.7894,1396.875 737.43,1397.0313 Q738.0863,1397.1875 738.6488,1397.4844 L738.6488,1400.2031 Q738.0238,1399.625 737.43,1399.3594 Q736.8363,1399.0781 736.2113,1399.0781 Q734.8675,1399.0781 734.18,1400.1563 Q733.4925,1401.2188 733.4925,1403.3125 Q733.4925,1405.4063 734.18,1406.4844 Q734.8675,1407.5469 736.2113,1407.5469 Q736.8363,1407.5469 737.43,1407.2813 Q738.0238,1407 738.6488,1406.4219 L738.6488,1409.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94" x="756.18" y="1408.156">ChromaDBClient</text><line style="stroke:#A80036;stroke-width:1.5;" x1="571.43" x2="1002.43" y1="1419.5" y2="1419.5"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="578.43" y="1427.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="63" x="590.43" y="1435.2589">db_path: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="578.43" y="1442.4819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="221" x="590.43" y="1450.2408">embedding_function: EmbeddingFunction</text><line style="stroke:#A80036;stroke-width:1.5;" x1="571.43" x2="1002.43" y1="1457.4638" y2="1457.4638"/><ellipse cx="581.43" cy="1468.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="333" x="590.43" y="1473.2227">__init__(db_path: str, embedding_function: EmbeddingFunction)</text><ellipse cx="581.43" cy="1483.4457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="195" x="590.43" y="1488.2046">get_collection(name: str) -&gt; Collection</text><ellipse cx="581.43" cy="1498.4276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="407" x="590.43" y="1503.1865">query_collection(collection_name: str, query: str, n_results: int) -&gt; QueryResult</text><!--MD5=[d06f0d82c524ff10da21e47294a8fb91]
class RetrievalResult--><rect codeLine="116" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="103.6339" id="RetrievalResult" style="stroke:#A80036;stroke-width:1.5;" width="139" x="79.43" y="1681.5"/><ellipse cx="105.23" cy="1702.8441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M108.1988,1708.4847 Q107.6206,1708.7816 106.98,1708.9222 Q106.3394,1709.0785 105.6363,1709.0785 Q103.1363,1709.0785 101.8081,1707.4379 Q100.4956,1705.7816 100.4956,1702.6566 Q100.4956,1699.5316 101.8081,1697.8754 Q103.1363,1696.2191 105.6363,1696.2191 Q106.3394,1696.2191 106.98,1696.3754 Q107.6363,1696.5316 108.1988,1696.8285 L108.1988,1699.5472 Q107.5738,1698.9691 106.98,1698.7035 Q106.3863,1698.4222 105.7613,1698.4222 Q104.4175,1698.4222 103.73,1699.5004 Q103.0425,1700.5629 103.0425,1702.6566 Q103.0425,1704.7504 103.73,1705.8285 Q104.4175,1706.891 105.7613,1706.891 Q106.3863,1706.891 106.98,1706.6254 Q107.5738,1706.3441 108.1988,1705.766 L108.1988,1708.4847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="58" x="134.13" y="1699.3281">«Pydantic»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="83" x="121.63" y="1715.6722">RetrievalResult</text><line style="stroke:#A80036;stroke-width:1.5;" x1="80.43" x2="217.43" y1="1724.1882" y2="1724.1882"/><ellipse cx="90.43" cy="1735.1882" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="60" x="99.43" y="1739.9471">content: str</text><ellipse cx="90.43" cy="1750.1701" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="74" x="99.43" y="1754.929">metadata: dict</text><ellipse cx="90.43" cy="1765.152" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="113" x="99.43" y="1769.9109">relevance_score: float</text><line style="stroke:#A80036;stroke-width:1.5;" x1="80.43" x2="217.43" y1="1777.1339" y2="1777.1339"/><!--MD5=[bea5b0d46523efab5ea1c1d339f396f0]
class Message--><rect codeLine="122" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="178.5433" id="Message" style="stroke:#A80036;stroke-width:1.5;" width="133" x="1596.43" y="7"/><ellipse cx="1632.58" cy="28.3441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1635.5488,33.9847 Q1634.9706,34.2816 1634.33,34.4222 Q1633.6894,34.5785 1632.9863,34.5785 Q1630.4863,34.5785 1629.1581,32.9379 Q1627.8456,31.2816 1627.8456,28.1566 Q1627.8456,25.0316 1629.1581,23.3754 Q1630.4863,21.7191 1632.9863,21.7191 Q1633.6894,21.7191 1634.33,21.8754 Q1634.9863,22.0316 1635.5488,22.3285 L1635.5488,25.0472 Q1634.9238,24.4691 1634.33,24.2035 Q1633.7363,23.9222 1633.1113,23.9222 Q1631.7675,23.9222 1631.08,25.0004 Q1630.3925,26.0629 1630.3925,28.1566 Q1630.3925,30.2504 1631.08,31.3285 Q1631.7675,32.391 1633.1113,32.391 Q1633.7363,32.391 1634.33,32.1254 Q1634.9238,31.8441 1635.5488,31.266 L1635.5488,33.9847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="58" x="1649.28" y="24.8281">«Pydantic»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="51" x="1652.78" y="41.1722">Message</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1597.43" x2="1728.43" y1="49.6882" y2="49.6882"/><ellipse cx="1607.43" cy="60.6882" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="60" x="1616.43" y="65.4471">content: str</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1619.43" y="80.429"/><ellipse cx="1607.43" cy="90.652" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="41" x="1616.43" y="95.4109">role: str</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1619.43" y="110.3928"/><ellipse cx="1607.43" cy="120.6158" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="107" x="1616.43" y="125.3747">timestamp: datetime</text><ellipse cx="1607.43" cy="135.5977" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="58" x="1616.43" y="140.3566">user_id: str</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="1619.43" y="155.3385"/><ellipse cx="1607.43" cy="165.5614" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="94" x="1616.43" y="170.3204">metadata: dict = {}</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1597.43" x2="1728.43" y1="177.5433" y2="177.5433"/><!--MD5=[9cb60460484123633ef0f92136195676]
class Reranker--><rect codeLine="135" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="152.8732" id="Reranker" style="stroke:#A80036;stroke-width:1.5;" width="389" x="146.43" y="1372.5"/><ellipse cx="311.18" cy="1388.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M314.1488,1394.1406 Q313.5706,1394.4375 312.93,1394.5781 Q312.2894,1394.7344 311.5863,1394.7344 Q309.0863,1394.7344 307.7581,1393.0938 Q306.4456,1391.4375 306.4456,1388.3125 Q306.4456,1385.1875 307.7581,1383.5313 Q309.0863,1381.875 311.5863,1381.875 Q312.2894,1381.875 312.93,1382.0313 Q313.5863,1382.1875 314.1488,1382.4844 L314.1488,1385.2031 Q313.5238,1384.625 312.93,1384.3594 Q312.3363,1384.0781 311.7113,1384.0781 Q310.3675,1384.0781 309.68,1385.1563 Q308.9925,1386.2188 308.9925,1388.3125 Q308.9925,1390.4063 309.68,1391.4844 Q310.3675,1392.5469 311.7113,1392.5469 Q312.3363,1392.5469 312.93,1392.2813 Q313.5238,1392 314.1488,1391.4219 L314.1488,1394.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="51" x="331.68" y="1393.156">Reranker</text><line style="stroke:#A80036;stroke-width:1.5;" x1="147.43" x2="534.43" y1="1404.5" y2="1404.5"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="154.43" y="1412.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="87" x="166.43" y="1420.2589">model_name: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="154.43" y="1427.4819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="59" x="166.43" y="1435.2408">model: Any</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="154.43" y="1442.4638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="49" x="166.43" y="1450.2227">top_k: int</text><line style="stroke:#A80036;stroke-width:1.5;" x1="147.43" x2="534.43" y1="1457.4457" y2="1457.4457"/><ellipse cx="157.43" cy="1468.4457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="358" x="166.43" y="1473.2046">__init__(model_name: str = "BAAI/bge-reranker-v2-m3", top_k: int = 3)</text><ellipse cx="157.43" cy="1483.4276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="363" x="166.43" y="1488.1865">rerank(query: str, results: List[RetrievalResult]) -&gt; List[RetrievalResult]</text><ellipse cx="157.43" cy="1498.4094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="356" x="166.43" y="1503.1684">calculate_rerank_scores(query: str, documents: List[str]) -&gt; List[float]</text><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="154.43" y="1510.3913"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="111" x="166.43" y="1518.1502">load_model() -&gt; None</text><!--MD5=[b729395d8bf66a7daa79b075ac5c26ef]
class LLMOrchestrator--><rect codeLine="160" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="182.837" id="LLMOrchestrator" style="stroke:#A80036;stroke-width:1.5;" width="516" x="1227.93" y="1642"/><ellipse cx="1434.18" cy="1658" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1437.1488,1663.6406 Q1436.5706,1663.9375 1435.93,1664.0781 Q1435.2894,1664.2344 1434.5863,1664.2344 Q1432.0863,1664.2344 1430.7581,1662.5938 Q1429.4456,1660.9375 1429.4456,1657.8125 Q1429.4456,1654.6875 1430.7581,1653.0313 Q1432.0863,1651.375 1434.5863,1651.375 Q1435.2894,1651.375 1435.93,1651.5313 Q1436.5863,1651.6875 1437.1488,1651.9844 L1437.1488,1654.7031 Q1436.5238,1654.125 1435.93,1653.8594 Q1435.3363,1653.5781 1434.7113,1653.5781 Q1433.3675,1653.5781 1432.68,1654.6563 Q1431.9925,1655.7188 1431.9925,1657.8125 Q1431.9925,1659.9063 1432.68,1660.9844 Q1433.3675,1662.0469 1434.7113,1662.0469 Q1435.3363,1662.0469 1435.93,1661.7813 Q1436.5238,1661.5 1437.1488,1660.9219 L1437.1488,1663.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="95" x="1454.68" y="1662.656">LLMOrchestrator</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1228.93" x2="1742.93" y1="1674" y2="1674"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1235.93" y="1682"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="59" x="1247.93" y="1689.7589">api_key: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1235.93" y="1696.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="64" x="1247.93" y="1704.7408">base_url: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1235.93" y="1711.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="87" x="1247.93" y="1719.7227">model_name: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1235.93" y="1726.9457"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="167" x="1247.93" y="1734.7046">prompt_builder: PromptBuilder</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1228.93" x2="1742.93" y1="1741.9276" y2="1741.9276"/><ellipse cx="1238.93" cy="1752.9276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="490" x="1247.93" y="1757.6865">__init__(api_key: str, model_name: str = "openai/gpt-oss-20b", prompt_builder: PromptBuilder)</text><ellipse cx="1238.93" cy="1767.9094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="171" x="1247.93" y="1772.6684">send_message(prompt: str) -&gt; str</text><ellipse cx="1238.93" cy="1782.8913" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="291" x="1247.93" y="1787.6502">send_message_stream(prompt: str) -&gt; AsyncIterator[str]</text><ellipse cx="1238.93" cy="1797.8732" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="342" x="1247.93" y="1802.6321">generate_response(query: str, context: List[RetrievalResult]) -&gt; str</text><ellipse cx="1238.93" cy="1812.8551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="462" x="1247.93" y="1817.614">generate_response_stream(query: str, context: List[RetrievalResult]) -&gt; AsyncIterator[str]</text><!--MD5=[00c497a4e2a9cd15275ba80e4742abc5]
class PromptBuilder--><rect codeLine="172" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="107.9276" id="PromptBuilder" style="stroke:#A80036;stroke-width:1.5;" width="340" x="1315.93" y="1904"/><ellipse cx="1441.18" cy="1920" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1444.1488,1925.6406 Q1443.5706,1925.9375 1442.93,1926.0781 Q1442.2894,1926.2344 1441.5863,1926.2344 Q1439.0863,1926.2344 1437.7581,1924.5938 Q1436.4456,1922.9375 1436.4456,1919.8125 Q1436.4456,1916.6875 1437.7581,1915.0313 Q1439.0863,1913.375 1441.5863,1913.375 Q1442.2894,1913.375 1442.93,1913.5313 Q1443.5863,1913.6875 1444.1488,1913.9844 L1444.1488,1916.7031 Q1443.5238,1916.125 1442.93,1915.8594 Q1442.3363,1915.5781 1441.7113,1915.5781 Q1440.3675,1915.5781 1439.68,1916.6563 Q1438.9925,1917.7188 1438.9925,1919.8125 Q1438.9925,1921.9063 1439.68,1922.9844 Q1440.3675,1924.0469 1441.7113,1924.0469 Q1442.3363,1924.0469 1442.93,1923.7813 Q1443.5238,1923.5 1444.1488,1922.9219 L1444.1488,1925.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="81" x="1461.68" y="1924.656">PromptBuilder</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1316.93" x2="1654.93" y1="1936" y2="1936"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1323.93" y="1944"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="140" x="1335.93" y="1951.7589">template: PromptTemplate</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1316.93" x2="1654.93" y1="1958.9819" y2="1958.9819"/><ellipse cx="1326.93" cy="1969.9819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="183" x="1335.93" y="1974.7408">__init__(template: PromptTemplate)</text><ellipse cx="1326.93" cy="1984.9638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="314" x="1335.93" y="1989.7227">build_prompt(query: str, context: List[RetrievalResult]) -&gt; str</text><ellipse cx="1326.93" cy="1999.9457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="261" x="1335.93" y="2004.7046">format_context(results: List[RetrievalResult]) -&gt; str</text><!--MD5=[38eb5a479ab8c919b746c0571501c77d]
class PromptTemplate--><rect codeLine="179" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="103.6339" id="PromptTemplate" style="stroke:#A80036;stroke-width:1.5;" width="144" x="1413.93" y="2091"/><ellipse cx="1437.03" cy="2112.3441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1439.9988,2117.9847 Q1439.4206,2118.2816 1438.78,2118.4222 Q1438.1394,2118.5785 1437.4363,2118.5785 Q1434.9363,2118.5785 1433.6081,2116.9379 Q1432.2956,2115.2816 1432.2956,2112.1566 Q1432.2956,2109.0316 1433.6081,2107.3754 Q1434.9363,2105.7191 1437.4363,2105.7191 Q1438.1394,2105.7191 1438.78,2105.8754 Q1439.4363,2106.0316 1439.9988,2106.3285 L1439.9988,2109.0472 Q1439.3738,2108.4691 1438.78,2108.2035 Q1438.1863,2107.9222 1437.5613,2107.9222 Q1436.2175,2107.9222 1435.53,2109.0004 Q1434.8425,2110.0629 1434.8425,2112.1566 Q1434.8425,2114.2504 1435.53,2115.3285 Q1436.2175,2116.391 1437.5613,2116.391 Q1438.1863,2116.391 1438.78,2116.1254 Q1439.3738,2115.8441 1439.9988,2115.266 L1439.9988,2117.9847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="58" x="1470.83" y="2108.8281">«Pydantic»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="94" x="1452.83" y="2125.1722">PromptTemplate</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1414.93" x2="1556.93" y1="2133.6882" y2="2133.6882"/><ellipse cx="1424.93" cy="2144.6882" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="118" x="1433.93" y="2149.4471">system_instruction: str</text><ellipse cx="1424.93" cy="2159.6701" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="108" x="1433.93" y="2164.429">instructions: List[str]</text><ellipse cx="1424.93" cy="2174.652" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="100" x="1433.93" y="2179.4109">context_format: str</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1414.93" x2="1556.93" y1="2186.6339" y2="2186.6339"/><!--MD5=[d2fab8e2abe7b5d5a263119cff4f3da5]
class ConversationManager--><rect codeLine="185" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="167.8551" id="ConversationManager" style="stroke:#A80036;stroke-width:1.5;" width="696" x="2606.93" y="1073"/><ellipse cx="2888.18" cy="1089" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2891.1488,1094.6406 Q2890.5706,1094.9375 2889.93,1095.0781 Q2889.2894,1095.2344 2888.5863,1095.2344 Q2886.0863,1095.2344 2884.7581,1093.5938 Q2883.4456,1091.9375 2883.4456,1088.8125 Q2883.4456,1085.6875 2884.7581,1084.0313 Q2886.0863,1082.375 2888.5863,1082.375 Q2889.2894,1082.375 2889.93,1082.5313 Q2890.5863,1082.6875 2891.1488,1082.9844 L2891.1488,1085.7031 Q2890.5238,1085.125 2889.93,1084.8594 Q2889.3363,1084.5781 2888.7113,1084.5781 Q2887.3675,1084.5781 2886.68,1085.6563 Q2885.9925,1086.7188 2885.9925,1088.8125 Q2885.9925,1090.9063 2886.68,1091.9844 Q2887.3675,1093.0469 2888.7113,1093.0469 Q2889.3363,1093.0469 2889.93,1092.7813 Q2890.5238,1092.5 2891.1488,1091.9219 L2891.1488,1094.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="125" x="2908.68" y="1093.656">ConversationManager</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2607.93" x2="3301.93" y1="1105" y2="1105"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="2614.93" y="1113"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="188" x="2626.93" y="1120.7589">repository: ConversationRepository</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="2614.93" y="1127.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="201" x="2626.93" y="1135.7408">summarizer: ConversationSummarizer</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="2614.93" y="1142.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="148" x="2626.93" y="1150.7227">enable_summarization: bool</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2607.93" x2="3301.93" y1="1157.9457" y2="1157.9457"/><ellipse cx="2617.93" cy="1168.9457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="670" x="2626.93" y="1173.7046">__init__(repository: ConversationRepository, summarizer: ConversationSummarizer = None, enable_summarization: bool = False)</text><ellipse cx="2617.93" cy="1183.9276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="381" x="2626.93" y="1188.6865">add_message(user_id: str, message: Message, is_logged_in: bool) -&gt; None</text><ellipse cx="2617.93" cy="1198.9094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="356" x="2626.93" y="1203.6684">get_conversation_history(user_id: str, limit: int = 20) -&gt; List[Message]</text><ellipse cx="2617.93" cy="1213.8913" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="321" x="2626.93" y="1218.6502">get_context_for_llm(user_id: str, max_tokens: int = 2000) -&gt; str</text><ellipse cx="2617.93" cy="1228.8732" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="206" x="2626.93" y="1233.6321">clear_conversation(user_id: str) -&gt; None</text><!--MD5=[a18127ddb73824da04e42583670e31e0]
class ConversationRepository--><rect codeLine="196" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="92.9457" id="ConversationRepository" style="stroke:#A80036;stroke-width:1.5;" width="309" x="3372.43" y="1402.5"/><ellipse cx="3458.68" cy="1418.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M3454.6019,1414.2656 L3454.6019,1412.1094 L3461.9925,1412.1094 L3461.9925,1414.2656 L3459.5238,1414.2656 L3459.5238,1422.3438 L3461.9925,1422.3438 L3461.9925,1424.5 L3454.6019,1424.5 L3454.6019,1422.3438 L3457.0706,1422.3438 L3457.0706,1414.2656 L3454.6019,1414.2656 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="128" x="3479.18" y="1423.156">ConversationRepository</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3373.43" x2="3680.43" y1="1434.5" y2="1434.5"/><line style="stroke:#A80036;stroke-width:1.5;" x1="3373.43" x2="3680.43" y1="1442.5" y2="1442.5"/><ellipse cx="3383.43" cy="1453.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="283" x="3392.43" y="1458.2589">save_message(user_id: str, message: Message) -&gt; None</text><ellipse cx="3383.43" cy="1468.4819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="272" x="3392.43" y="1473.2408">get_messages(user_id: str, limit: int) -&gt; List[Message]</text><ellipse cx="3383.43" cy="1483.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="213" x="3392.43" y="1488.2227">delete_conversation(user_id: str) -&gt; None</text><!--MD5=[3d11532b77a2aaab97a6929859825e3b]
class DatabaseConversationRepository--><rect codeLine="202" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="122.9094" id="DatabaseConversationRepository" style="stroke:#A80036;stroke-width:1.5;" width="309" x="3733.43" y="1095.5"/><ellipse cx="3790.18" cy="1111.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M3793.1488,1117.1406 Q3792.5706,1117.4375 3791.93,1117.5781 Q3791.2894,1117.7344 3790.5863,1117.7344 Q3788.0863,1117.7344 3786.7581,1116.0938 Q3785.4456,1114.4375 3785.4456,1111.3125 Q3785.4456,1108.1875 3786.7581,1106.5313 Q3788.0863,1104.875 3790.5863,1104.875 Q3791.2894,1104.875 3791.93,1105.0313 Q3792.5863,1105.1875 3793.1488,1105.4844 L3793.1488,1108.2031 Q3792.5238,1107.625 3791.93,1107.3594 Q3791.3363,1107.0781 3790.7113,1107.0781 Q3789.3675,1107.0781 3788.68,1108.1563 Q3787.9925,1109.2188 3787.9925,1111.3125 Q3787.9925,1113.4063 3788.68,1114.4844 Q3789.3675,1115.5469 3790.7113,1115.5469 Q3791.3363,1115.5469 3791.93,1115.2813 Q3792.5238,1115 3793.1488,1114.4219 L3793.1488,1117.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="187" x="3810.68" y="1116.156">DatabaseConversationRepository</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3734.43" x2="4041.43" y1="1127.5" y2="1127.5"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3741.43" y="1135.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="156" x="3753.43" y="1143.2589">db_helper: PostgreSQLHelper</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3734.43" x2="4041.43" y1="1150.4819" y2="1150.4819"/><ellipse cx="3744.43" cy="1161.4819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="199" x="3753.43" y="1166.2408">__init__(db_helper: PostgreSQLHelper)</text><ellipse cx="3744.43" cy="1176.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="283" x="3753.43" y="1181.2227">save_message(user_id: str, message: Message) -&gt; None</text><ellipse cx="3744.43" cy="1191.4457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="272" x="3753.43" y="1196.2046">get_messages(user_id: str, limit: int) -&gt; List[Message]</text><ellipse cx="3744.43" cy="1206.4276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="213" x="3753.43" y="1211.1865">delete_conversation(user_id: str) -&gt; None</text><!--MD5=[42f4148ed46d7bffe83597c0d19bde41]
class FileConversationRepository--><rect codeLine="210" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="122.9094" id="FileConversationRepository" style="stroke:#A80036;stroke-width:1.5;" width="309" x="3372.43" y="1095.5"/><ellipse cx="3446.68" cy="1111.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M3449.6488,1117.1406 Q3449.0706,1117.4375 3448.43,1117.5781 Q3447.7894,1117.7344 3447.0863,1117.7344 Q3444.5863,1117.7344 3443.2581,1116.0938 Q3441.9456,1114.4375 3441.9456,1111.3125 Q3441.9456,1108.1875 3443.2581,1106.5313 Q3444.5863,1104.875 3447.0863,1104.875 Q3447.7894,1104.875 3448.43,1105.0313 Q3449.0863,1105.1875 3449.6488,1105.4844 L3449.6488,1108.2031 Q3449.0238,1107.625 3448.43,1107.3594 Q3447.8363,1107.0781 3447.2113,1107.0781 Q3445.8675,1107.0781 3445.18,1108.1563 Q3444.4925,1109.2188 3444.4925,1111.3125 Q3444.4925,1113.4063 3445.18,1114.4844 Q3445.8675,1115.5469 3447.2113,1115.5469 Q3447.8363,1115.5469 3448.43,1115.2813 Q3449.0238,1115 3449.6488,1114.4219 L3449.6488,1117.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="152" x="3467.18" y="1116.156">FileConversationRepository</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3373.43" x2="3680.43" y1="1127.5" y2="1127.5"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3380.43" y="1135.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="89" x="3392.43" y="1143.2589">storage_path: str</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3373.43" x2="3680.43" y1="1150.4819" y2="1150.4819"/><ellipse cx="3383.43" cy="1161.4819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="232" x="3392.43" y="1166.2408">__init__(storage_path: str = "./conversations")</text><ellipse cx="3383.43" cy="1176.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="283" x="3392.43" y="1181.2227">save_message(user_id: str, message: Message) -&gt; None</text><ellipse cx="3383.43" cy="1191.4457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="272" x="3392.43" y="1196.2046">get_messages(user_id: str, limit: int) -&gt; List[Message]</text><ellipse cx="3383.43" cy="1206.4276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="213" x="3392.43" y="1211.1865">delete_conversation(user_id: str) -&gt; None</text><!--MD5=[e78300afe35fb3639054d9a80de20950]
class ConversationSummarizer--><rect codeLine="218" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="227.7827" id="ConversationSummarizer" style="stroke:#A80036;stroke-width:1.5;" width="548" x="2788.93" y="1335"/><ellipse cx="2987.18" cy="1351" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2990.1488,1356.6406 Q2989.5706,1356.9375 2988.93,1357.0781 Q2988.2894,1357.2344 2987.5863,1357.2344 Q2985.0863,1357.2344 2983.7581,1355.5938 Q2982.4456,1353.9375 2982.4456,1350.8125 Q2982.4456,1347.6875 2983.7581,1346.0313 Q2985.0863,1344.375 2987.5863,1344.375 Q2988.2894,1344.375 2988.93,1344.5313 Q2989.5863,1344.6875 2990.1488,1344.9844 L2990.1488,1347.7031 Q2989.5238,1347.125 2988.93,1346.8594 Q2988.3363,1346.5781 2987.7113,1346.5781 Q2986.3675,1346.5781 2985.68,1347.6563 Q2984.9925,1348.7188 2984.9925,1350.8125 Q2984.9925,1352.9063 2985.68,1353.9844 Q2986.3675,1355.0469 2987.7113,1355.0469 Q2988.3363,1355.0469 2988.93,1354.7813 Q2989.5238,1354.5 2990.1488,1353.9219 L2990.1488,1356.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="143" x="3007.68" y="1355.656">ConversationSummarizer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2789.93" x2="3335.93" y1="1367" y2="1367"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="2796.93" y="1375"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="183" x="2808.93" y="1382.7589">llm_orchestrator: LLMOrchestrator</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="2796.93" y="1389.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="170" x="2808.93" y="1397.7408">storage_summary_threshold: int</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="2796.93" y="1404.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="174" x="2808.93" y="1412.7227">retrieval_summary_threshold: int</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2789.93" x2="3335.93" y1="1419.9457" y2="1419.9457"/><ellipse cx="2799.93" cy="1430.9457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="522" x="2808.93" y="1435.7046">__init__(llm_orchestrator: LLMOrchestrator, storage_threshold: int = 50, retrieval_threshold: int = 20)</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="2811.93" y="1450.6865"/><ellipse cx="2799.93" cy="1460.9094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="317" x="2808.93" y="1465.6684">summarize_for_storage(messages: List[Message]) -&gt; Message</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="2811.93" y="1480.6502"/><ellipse cx="2799.93" cy="1490.8732" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="402" x="2808.93" y="1495.6321">summarize_for_retrieval(messages: List[Message], recent_count: int = 5) -&gt; str</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="2811.93" y="1510.614"/><ellipse cx="2799.93" cy="1520.837" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="289" x="2808.93" y="1525.5959">should_summarize_storage(message_count: int) -&gt; bool</text><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="0" x="2811.93" y="1540.5778"/><ellipse cx="2799.93" cy="1550.8008" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="293" x="2808.93" y="1555.5597">should_summarize_retrieval(message_count: int) -&gt; bool</text><!--MD5=[ae3bb9eb48e1710b8c32d075f2b29f4e]
class IDatabase--><rect codeLine="246" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="107.9276" id="IDatabase" style="stroke:#A80036;stroke-width:1.5;" width="378" x="3716.93" y="1679.5"/><ellipse cx="3874.18" cy="1695.5" fill="#B4A7E5" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M3870.1019,1691.2656 L3870.1019,1689.1094 L3877.4925,1689.1094 L3877.4925,1691.2656 L3875.0238,1691.2656 L3875.0238,1699.3438 L3877.4925,1699.3438 L3877.4925,1701.5 L3870.1019,1701.5 L3870.1019,1699.3438 L3872.5706,1699.3438 L3872.5706,1691.2656 L3870.1019,1691.2656 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="55" x="3894.68" y="1700.156">IDatabase</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3717.93" x2="4093.93" y1="1711.5" y2="1711.5"/><line style="stroke:#A80036;stroke-width:1.5;" x1="3717.93" x2="4093.93" y1="1719.5" y2="1719.5"/><ellipse cx="3727.93" cy="1730.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="62" x="3736.93" y="1735.2589">disconnect()</text><ellipse cx="3727.93" cy="1745.4819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="223" x="3736.93" y="1750.2408">fetch_data(query: str, params: tuple) -&gt; List</text><ellipse cx="3727.93" cy="1760.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="352" x="3736.93" y="1765.2227">execute_query(query: str, params: tuple, commit: bool = True) -&gt; int</text><ellipse cx="3727.93" cy="1775.4457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="114" x="3736.93" y="1780.2046">commit_transactions()</text><!--MD5=[d64c9fad270d9c1f0b1efed900fe1f58]
class PostgreSQLHelper--><rect codeLine="253" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="227.7827" id="PostgreSQLHelper" style="stroke:#A80036;stroke-width:1.5;" width="378" x="3716.93" y="1335"/><ellipse cx="3850.18" cy="1351" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M3853.1488,1356.6406 Q3852.5706,1356.9375 3851.93,1357.0781 Q3851.2894,1357.2344 3850.5863,1357.2344 Q3848.0863,1357.2344 3846.7581,1355.5938 Q3845.4456,1353.9375 3845.4456,1350.8125 Q3845.4456,1347.6875 3846.7581,1346.0313 Q3848.0863,1344.375 3850.5863,1344.375 Q3851.2894,1344.375 3851.93,1344.5313 Q3852.5863,1344.6875 3853.1488,1344.9844 L3853.1488,1347.7031 Q3852.5238,1347.125 3851.93,1346.8594 Q3851.3363,1346.5781 3850.7113,1346.5781 Q3849.3675,1346.5781 3848.68,1347.6563 Q3847.9925,1348.7188 3847.9925,1350.8125 Q3847.9925,1352.9063 3848.68,1353.9844 Q3849.3675,1355.0469 3850.7113,1355.0469 Q3851.3363,1355.0469 3851.93,1354.7813 Q3852.5238,1354.5 3853.1488,1353.9219 L3853.1488,1356.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="103" x="3870.68" y="1355.656">PostgreSQLHelper</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3717.93" x2="4093.93" y1="1367" y2="1367"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3724.93" y="1375"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="78" x="3736.93" y="1382.7589">db_schema: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3724.93" y="1389.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="39" x="3736.93" y="1397.7408">env: str</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3724.93" y="1404.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="154" x="3736.93" y="1412.7227">connection: AsyncConnection</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3724.93" y="1419.9457"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="106" x="3736.93" y="1427.7046">cursor: AsyncCursor</text><line style="stroke:#A80036;stroke-width:1.5;" x1="3717.93" x2="4093.93" y1="1434.9276" y2="1434.9276"/><ellipse cx="3727.93" cy="1445.9276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="217" x="3736.93" y="1450.6865">__init__(db_schema: str, env: str = "PROD")</text><ellipse cx="3727.93" cy="1460.9094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="106" x="3736.93" y="1465.6684">disconnect() -&gt; None</text><ellipse cx="3727.93" cy="1475.8913" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="223" x="3736.93" y="1480.6502">fetch_data(query: str, params: tuple) -&gt; List</text><ellipse cx="3727.93" cy="1490.8732" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="352" x="3736.93" y="1495.6321">execute_query(query: str, params: tuple, commit: bool = True) -&gt; int</text><ellipse cx="3727.93" cy="1505.8551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="158" x="3736.93" y="1510.614">commit_transactions() -&gt; None</text><rect fill="#F24D5C" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="3724.93" y="1517.837"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="118" x="3736.93" y="1525.5959">__get_conn_str() -&gt; dict</text><ellipse cx="3727.93" cy="1535.8189" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="167" x="3736.93" y="1540.5778">__enter__() -&gt; PostgreSQLHelper</text><ellipse cx="3727.93" cy="1550.8008" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="246" x="3736.93" y="1555.5597">__exit__(exc_type, exc_value, traceback) -&gt; None</text><!--MD5=[1170f6ec86d50b38e1ce2dfb0036cc65]
class ClarificationManager--><rect codeLine="269" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="197.8189" id="ClarificationManager" style="stroke:#A80036;stroke-width:1.5;" width="615" x="1137.43" y="1058"/><ellipse cx="1381.68" cy="1074" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1384.6488,1079.6406 Q1384.0706,1079.9375 1383.43,1080.0781 Q1382.7894,1080.2344 1382.0863,1080.2344 Q1379.5863,1080.2344 1378.2581,1078.5938 Q1376.9456,1076.9375 1376.9456,1073.8125 Q1376.9456,1070.6875 1378.2581,1069.0313 Q1379.5863,1067.375 1382.0863,1067.375 Q1382.7894,1067.375 1383.43,1067.5313 Q1384.0863,1067.6875 1384.6488,1067.9844 L1384.6488,1070.7031 Q1384.0238,1070.125 1383.43,1069.8594 Q1382.8363,1069.5781 1382.2113,1069.5781 Q1380.8675,1069.5781 1380.18,1070.6563 Q1379.4925,1071.7188 1379.4925,1073.8125 Q1379.4925,1075.9063 1380.18,1076.9844 Q1380.8675,1078.0469 1382.2113,1078.0469 Q1382.8363,1078.0469 1383.43,1077.7813 Q1384.0238,1077.5 1384.6488,1076.9219 L1384.6488,1079.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="118" x="1402.18" y="1078.656">ClarificationManager</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1138.43" x2="1751.43" y1="1090" y2="1090"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1145.43" y="1098"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="183" x="1157.43" y="1105.7589">llm_orchestrator: LLMOrchestrator</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1145.43" y="1112.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="143" x="1157.43" y="1120.7408">confidence_threshold: float</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1145.43" y="1127.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="93" x="1157.43" y="1135.7227">max_attempts: int</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1145.43" y="1142.9457"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="108" x="1157.43" y="1150.7046">attempt_tracker: dict</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1138.43" x2="1751.43" y1="1157.9276" y2="1157.9276"/><ellipse cx="1148.43" cy="1168.9276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="519" x="1157.43" y="1173.6865">__init__(llm_orchestrator: LLMOrchestrator, confidence_threshold: float = 0.7, max_attempts: int = 2)</text><ellipse cx="1148.43" cy="1183.9094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="270" x="1157.43" y="1188.6684">should_clarify(user_id: str, confidence: float) -&gt; bool</text><ellipse cx="1148.43" cy="1198.8913" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="589" x="1157.43" y="1203.6502">generate_clarifying_question(query: str, context: List[RetrievalResult], confidence_result: ConfidenceResult) -&gt; str</text><ellipse cx="1148.43" cy="1213.8732" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="193" x="1157.43" y="1218.6321">increment_attempt(user_id: str) -&gt; int</text><ellipse cx="1148.43" cy="1228.8551" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="185" x="1157.43" y="1233.614">reset_attempts(user_id: str) -&gt; None</text><ellipse cx="1148.43" cy="1243.837" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="162" x="1157.43" y="1248.5959">get_attempts(user_id: str) -&gt; int</text><!--MD5=[6c3294ce43f5fb8beddece7c22387dc9]
class ConfidenceScorer--><rect codeLine="281" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="137.8913" id="ConfidenceScorer" style="stroke:#A80036;stroke-width:1.5;" width="612" x="1892.93" y="1088"/><ellipse cx="2144.68" cy="1104" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2147.6488,1109.6406 Q2147.0706,1109.9375 2146.43,1110.0781 Q2145.7894,1110.2344 2145.0863,1110.2344 Q2142.5863,1110.2344 2141.2581,1108.5938 Q2139.9456,1106.9375 2139.9456,1103.8125 Q2139.9456,1100.6875 2141.2581,1099.0313 Q2142.5863,1097.375 2145.0863,1097.375 Q2145.7894,1097.375 2146.43,1097.5313 Q2147.0863,1097.6875 2147.6488,1097.9844 L2147.6488,1100.7031 Q2147.0238,1100.125 2146.43,1099.8594 Q2145.8363,1099.5781 2145.2113,1099.5781 Q2143.8675,1099.5781 2143.18,1100.6563 Q2142.4925,1101.7188 2142.4925,1103.8125 Q2142.4925,1105.9063 2143.18,1106.9844 Q2143.8675,1108.0469 2145.2113,1108.0469 Q2145.8363,1108.0469 2146.43,1107.7813 Q2147.0238,1107.5 2147.6488,1106.9219 L2147.6488,1109.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="100" x="2165.18" y="1108.656">ConfidenceScorer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1893.93" x2="2503.93" y1="1120" y2="1120"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1900.93" y="1128"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="227" x="1912.93" y="1135.7589">retrieval_scorer: RetrievalConfidenceScorer</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1900.93" y="1142.9819"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="175" x="1912.93" y="1150.7408">llm_scorer: LLMConfidenceScorer</text><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1900.93" y="1157.9638"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="129" x="1912.93" y="1165.7227">weights: ScoringWeights</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1893.93" x2="2503.93" y1="1172.9457" y2="1172.9457"/><ellipse cx="1903.93" cy="1183.9457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="586" x="1912.93" y="1188.7046">__init__(retrieval_scorer: RetrievalConfidenceScorer, llm_scorer: LLMConfidenceScorer, weights: ScoringWeights)</text><ellipse cx="1903.93" cy="1198.9276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="566" x="1912.93" y="1203.6865">calculate_confidence(retrieval_results: List[RetrievalResult], llm_response: str, query: str) -&gt; ConfidenceResult</text><ellipse cx="1903.93" cy="1213.9094" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="326" x="1912.93" y="1218.6684">get_overall_score(confidence_result: ConfidenceResult) -&gt; float</text><!--MD5=[32bf57e41386822569cfdebecc76d5e2]
class RetrievalConfidenceScorer--><rect codeLine="290" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="122.9094" id="RetrievalConfidenceScorer" style="stroke:#A80036;stroke-width:1.5;" width="341" x="1788.43" y="1387.5"/><ellipse cx="1880.18" cy="1403.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1883.1488,1409.1406 Q1882.5706,1409.4375 1881.93,1409.5781 Q1881.2894,1409.7344 1880.5863,1409.7344 Q1878.0863,1409.7344 1876.7581,1408.0938 Q1875.4456,1406.4375 1875.4456,1403.3125 Q1875.4456,1400.1875 1876.7581,1398.5313 Q1878.0863,1396.875 1880.5863,1396.875 Q1881.2894,1396.875 1881.93,1397.0313 Q1882.5863,1397.1875 1883.1488,1397.4844 L1883.1488,1400.2031 Q1882.5238,1399.625 1881.93,1399.3594 Q1881.3363,1399.0781 1880.7113,1399.0781 Q1879.3675,1399.0781 1878.68,1400.1563 Q1877.9925,1401.2188 1877.9925,1403.3125 Q1877.9925,1405.4063 1878.68,1406.4844 Q1879.3675,1407.5469 1880.7113,1407.5469 Q1881.3363,1407.5469 1881.93,1407.2813 Q1882.5238,1407 1883.1488,1406.4219 L1883.1488,1409.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="149" x="1900.68" y="1408.156">RetrievalConfidenceScorer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1789.43" x2="2128.43" y1="1419.5" y2="1419.5"/><rect fill="none" height="6" style="stroke:#C82930;stroke-width:1.0;" width="6" x="1796.43" y="1427.5"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="161" x="1808.43" y="1435.2589">min_relevance_threshold: float</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1789.43" x2="2128.43" y1="1442.4819" y2="1442.4819"/><ellipse cx="1799.43" cy="1453.4819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="231" x="1808.43" y="1458.2408">__init__(min_relevance_threshold: float = 0.7)</text><ellipse cx="1799.43" cy="1468.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="268" x="1808.43" y="1473.2227">score(retrieval_results: List[RetrievalResult]) -&gt; float</text><ellipse cx="1799.43" cy="1483.4457" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="315" x="1808.43" y="1488.2046">calculate_avg_relevance(results: List[RetrievalResult]) -&gt; float</text><ellipse cx="1799.43" cy="1498.4276" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="273" x="1808.43" y="1503.1865">check_coverage(results: List[RetrievalResult]) -&gt; bool</text><!--MD5=[a23367bc12b172b081cb539c9b40961f]
class LLMConfidenceScorer--><rect codeLine="298" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="92.9457" id="LLMConfidenceScorer" style="stroke:#A80036;stroke-width:1.5;" width="386" x="2164.93" y="1402.5"/><ellipse cx="2292.18" cy="1418.5" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2295.1488,1424.1406 Q2294.5706,1424.4375 2293.93,1424.5781 Q2293.2894,1424.7344 2292.5863,1424.7344 Q2290.0863,1424.7344 2288.7581,1423.0938 Q2287.4456,1421.4375 2287.4456,1418.3125 Q2287.4456,1415.1875 2288.7581,1413.5313 Q2290.0863,1411.875 2292.5863,1411.875 Q2293.2894,1411.875 2293.93,1412.0313 Q2294.5863,1412.1875 2295.1488,1412.4844 L2295.1488,1415.2031 Q2294.5238,1414.625 2293.93,1414.3594 Q2293.3363,1414.0781 2292.7113,1414.0781 Q2291.3675,1414.0781 2290.68,1415.1563 Q2289.9925,1416.2188 2289.9925,1418.3125 Q2289.9925,1420.4063 2290.68,1421.4844 Q2291.3675,1422.5469 2292.7113,1422.5469 Q2293.3363,1422.5469 2293.93,1422.2813 Q2294.5238,1422 2295.1488,1421.4219 L2295.1488,1424.1406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="123" x="2312.68" y="1423.156">LLMConfidenceScorer</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2165.93" x2="2549.93" y1="1434.5" y2="1434.5"/><line style="stroke:#A80036;stroke-width:1.5;" x1="2165.93" x2="2549.93" y1="1442.5" y2="1442.5"/><ellipse cx="2175.93" cy="1453.5" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="354" x="2184.93" y="1458.2589">score(response: str, query: str, context: List[RetrievalResult]) -&gt; float</text><ellipse cx="2175.93" cy="1468.4819" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="237" x="2184.93" y="1473.2408">check_response_quality(response: str) -&gt; float</text><ellipse cx="2175.93" cy="1483.4638" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="360" x="2184.93" y="1488.2227">check_grounding(response: str, context: List[RetrievalResult]) -&gt; float</text><!--MD5=[9b7fdd8d4af81ad9c04e3476f81a23a3]
class ConfidenceResult--><rect codeLine="304" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="133.5977" id="ConfidenceResult" style="stroke:#A80036;stroke-width:1.5;" width="173" x="1580.43" y="1382"/><ellipse cx="1615.23" cy="1403.3441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1618.1988,1408.9847 Q1617.6206,1409.2816 1616.98,1409.4222 Q1616.3394,1409.5785 1615.6363,1409.5785 Q1613.1363,1409.5785 1611.8081,1407.9379 Q1610.4956,1406.2816 1610.4956,1403.1566 Q1610.4956,1400.0316 1611.8081,1398.3754 Q1613.1363,1396.7191 1615.6363,1396.7191 Q1616.3394,1396.7191 1616.98,1396.8754 Q1617.6363,1397.0316 1618.1988,1397.3285 L1618.1988,1400.0472 Q1617.5738,1399.4691 1616.98,1399.2035 Q1616.3863,1398.9222 1615.7613,1398.9222 Q1614.4175,1398.9222 1613.73,1400.0004 Q1613.0425,1401.0629 1613.0425,1403.1566 Q1613.0425,1405.2504 1613.73,1406.3285 Q1614.4175,1407.391 1615.7613,1407.391 Q1616.3863,1407.391 1616.98,1407.1254 Q1617.5738,1406.8441 1618.1988,1406.266 L1618.1988,1408.9847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="58" x="1653.13" y="1399.8281">«Pydantic»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="97" x="1633.63" y="1416.1722">ConfidenceResult</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1581.43" x2="1752.43" y1="1424.6882" y2="1424.6882"/><ellipse cx="1591.43" cy="1435.6882" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="136" x="1600.43" y="1440.4471">retrieval_confidence: float</text><ellipse cx="1591.43" cy="1450.6701" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="108" x="1600.43" y="1455.429">llm_confidence: float</text><ellipse cx="1591.43" cy="1465.652" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="128" x="1600.43" y="1470.4109">overall_confidence: float</text><ellipse cx="1591.43" cy="1480.6339" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="93" x="1600.43" y="1485.3928">is_confident: bool</text><ellipse cx="1591.43" cy="1495.6158" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="147" x="1600.43" y="1500.3747">confidence_breakdown: dict</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1581.43" x2="1752.43" y1="1507.5977" y2="1507.5977"/><!--MD5=[1807ef1db117f0c8d78cf4b02b56325e]
class ScoringWeights--><rect codeLine="312" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="88.652" id="ScoringWeights" style="stroke:#A80036;stroke-width:1.5;" width="168" x="2585.93" y="1404.5"/><ellipse cx="2622.98" cy="1425.8441" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M2625.9488,1431.4847 Q2625.3706,1431.7816 2624.73,1431.9222 Q2624.0894,1432.0785 2623.3863,1432.0785 Q2620.8863,1432.0785 2619.5581,1430.4379 Q2618.2456,1428.7816 2618.2456,1425.6566 Q2618.2456,1422.5316 2619.5581,1420.8754 Q2620.8863,1419.2191 2623.3863,1419.2191 Q2624.0894,1419.2191 2624.73,1419.3754 Q2625.3863,1419.5316 2625.9488,1419.8285 L2625.9488,1422.5472 Q2625.3238,1421.9691 2624.73,1421.7035 Q2624.1363,1421.4222 2623.5113,1421.4222 Q2622.1675,1421.4222 2621.48,1422.5004 Q2620.7925,1423.5629 2620.7925,1425.6566 Q2620.7925,1427.7504 2621.48,1428.8285 Q2622.1675,1429.891 2623.5113,1429.891 Q2624.1363,1429.891 2624.73,1429.6254 Q2625.3238,1429.3441 2625.9488,1428.766 L2625.9488,1431.4847 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="58" x="2656.38" y="1422.3281">«Pydantic»</text><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="87" x="2641.88" y="1438.6722">ScoringWeights</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2586.93" x2="2752.93" y1="1447.1882" y2="1447.1882"/><ellipse cx="2596.93" cy="1458.1882" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="142" x="2605.93" y="1462.9471">retrieval_weight: float = 0.4</text><ellipse cx="2596.93" cy="1473.1701" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="114" x="2605.93" y="1477.929">llm_weight: float = 0.6</text><line style="stroke:#A80036;stroke-width:1.5;" x1="2586.93" x2="2752.93" y1="1485.152" y2="1485.152"/><!--MD5=[edcb87bf0417fe2db8c7eaa6d6c62efe]
class DocumentEncoder--><rect codeLine="316" fill="#FEFECE" filter="url(#fqa89q5t8z60i)" height="62.9819" id="DocumentEncoder" style="stroke:#A80036;stroke-width:1.5;" width="230" x="1764.93" y="65"/><ellipse cx="1823.68" cy="81" fill="#ADD1B2" rx="11" ry="11" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1826.6488,86.6406 Q1826.0706,86.9375 1825.43,87.0781 Q1824.7894,87.2344 1824.0863,87.2344 Q1821.5863,87.2344 1820.2581,85.5938 Q1818.9456,83.9375 1818.9456,80.8125 Q1818.9456,77.6875 1820.2581,76.0313 Q1821.5863,74.375 1824.0863,74.375 Q1824.7894,74.375 1825.43,74.5313 Q1826.0863,74.6875 1826.6488,74.9844 L1826.6488,77.7031 Q1826.0238,77.125 1825.43,76.8594 Q1824.8363,76.5781 1824.2113,76.5781 Q1822.8675,76.5781 1822.18,77.6563 Q1821.4925,78.7188 1821.4925,80.8125 Q1821.4925,82.9063 1822.18,83.9844 Q1822.8675,85.0469 1824.2113,85.0469 Q1824.8363,85.0469 1825.43,84.7813 Q1826.0238,84.5 1826.6488,83.9219 L1826.6488,86.6406 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" lengthAdjust="spacing" textLength="104" x="1844.18" y="85.656">DocumentEncoder</text><line style="stroke:#A80036;stroke-width:1.5;" x1="1765.93" x2="1993.93" y1="97" y2="97"/><line style="stroke:#A80036;stroke-width:1.5;" x1="1765.93" x2="1993.93" y1="105" y2="105"/><ellipse cx="1775.93" cy="116" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="11" lengthAdjust="spacing" textLength="204" x="1784.93" y="120.7589">encode(documents: List[str]) -&gt; List[str]</text><!--MD5=[17bf0144cce51c58413bcf48c8fb6a28]
link Main to Routes--><path codeLine="320" d="M1515.93,141.22 C1515.93,175.73 1515.93,223.87 1515.93,259.65 " fill="none" id="Main-to-Routes" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1515.93,264.84,1519.93,255.84,1515.93,259.84,1511.93,255.84,1515.93,264.84" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="1516.93" y="230.897">includes</text><!--MD5=[6ec7854f33958318aa674a4b3fa839c1]
link Routes to Dependencies--><path codeLine="321" d="M1515.93,354.28 C1515.93,376.59 1515.93,403.96 1515.93,427.81 " fill="none" id="Routes-to-Dependencies" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1515.93,432.84,1519.93,423.84,1515.93,427.84,1511.93,423.84,1515.93,432.84" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1516.93" y="398.897">uses</text><!--MD5=[60c20b0e591ef9290ea9cd21d716f930]
link Dependencies to ResponseManager--><path codeLine="322" d="M1573.72,537.27 C1597.88,558.71 1627.56,585.04 1658.65,612.61 " fill="none" id="Dependencies-to-ResponseManager" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1662.44,615.98,1658.3899,607.0024,1658.7101,612.6502,1653.0623,612.9703,1662.44,615.98" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="1619.93" y="581.897">creates</text><!--MD5=[0bf9e49ae36f7d7ee10c8b83d4dfcccc]
link Dependencies to VectorRetriever--><path codeLine="323" d="M1382.32,498.49 C1260.26,511.65 1090.08,534.94 1030.93,567 C840.77,670.07 765.97,939.3 739.64,1075.13 " fill="none" id="Dependencies-to-VectorRetriever" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="738.65,1080.31,744.2742,1072.2249,739.5921,1075.3996,736.4175,1070.7175,738.65,1080.31" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="960.93" y="802.897">creates</text><!--MD5=[a9e0fba174283e7ce8e6607c75ff3bee]
link Dependencies to LLMOrchestrator--><path codeLine="324" d="M1382.36,493.2 C1292.51,505.52 1178.98,537.02 1113.93,616 C1060.44,680.93 1056.93,712.37 1056.93,796.5 C1056.93,796.5 1056.93,796.5 1056.93,1450 C1056.93,1546.9 1134.22,1612.44 1223.2,1655.78 " fill="none" id="Dependencies-to-LLMOrchestrator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1227.71,1657.96,1221.3427,1650.4462,1223.2069,1655.7871,1217.866,1657.6512,1227.71,1657.96" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="1057.93" y="1162.397">creates</text><!--MD5=[586783d2bb1d96245cddfec7f3bff146]
link Dependencies to ConfidenceScorer--><path codeLine="325" d="M1649.85,493.96 C1906.56,510.6 2447.52,552.81 2502.93,616 C2609.3,737.3 2583.34,839.13 2502.93,979 C2476.9,1024.26 2434.36,1059.04 2389.23,1085.28 " fill="none" id="Dependencies-to-ConfidenceScorer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2384.85,1087.79,2394.648,1086.7908,2389.1895,1085.3062,2390.674,1079.8477,2384.85,1087.79" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="2573.93" y="802.897">creates</text><!--MD5=[e36b7ca056851320901ff0c19bab666f]
link Dependencies to ClarificationManager--><path codeLine="326" d="M1382.16,502.2 C1310.61,518.43 1228.32,550.94 1183.93,616 C1092.99,749.26 1108.36,836.46 1183.93,979 C1199.26,1007.93 1221.67,1033 1247.02,1054.44 " fill="none" id="Dependencies-to-ClarificationManager" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1251.11,1057.85,1246.7535,1049.017,1247.2677,1054.6505,1241.6343,1055.1647,1251.11,1057.85" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="1184.93" y="802.897">creates</text><!--MD5=[1499b53fb6bcaa8dee840e12d097bb65]
link Dependencies to ConversationManager--><path codeLine="327" d="M1649.67,485.66 C1910.11,487.52 2473.18,504.71 2625.93,616 C2783.67,730.93 2880.99,946.67 2925.73,1067.77 " fill="none" id="Dependencies-to-ConversationManager" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2927.56,1072.75,2928.1979,1062.9218,2925.8295,1068.059,2920.6923,1065.6906,2927.56,1072.75" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="2889.93" y="802.897">creates</text><!--MD5=[afdae224e5863b28cfef206daa95cba4]
link ResponseManager to VectorRetriever--><path codeLine="329" d="M1264.1,979.06 C1179.95,1005.11 1094.67,1031.93 1013.93,1058 C993.31,1064.66 971.92,1071.7 950.51,1078.84 " fill="none" id="ResponseManager-to-VectorRetriever" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="945.66,1080.47,955.4639,1081.4098,950.402,1078.8846,952.9272,1073.8226,945.66,1080.47" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1153.93" y="1023.897">uses</text><!--MD5=[da90f18245cb45a079a6a21520c5a0e0]
link ResponseManager to LLMOrchestrator--><path codeLine="330" d="M1874.46,979.05 C1868.82,1074.55 1844.35,1186.17 1769.93,1256 C1701.82,1319.91 1628.8,1220.8 1561.93,1286 C1549.41,1298.21 1517.58,1509.09 1499.33,1636.61 " fill="none" id="ResponseManager-to-LLMOrchestrator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1498.58,1641.87,1503.8025,1633.5198,1499.2811,1636.9194,1495.8815,1632.398,1498.58,1641.87" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1562.93" y="1300.897">uses</text><!--MD5=[cdc3c156044d5ad1fe47eab0a27bc0df]
link ResponseManager to ConfidenceScorer--><path codeLine="331" d="M2034.13,979.08 C2068.89,1016.4 2103.55,1053.61 2132.05,1084.2 " fill="none" id="ResponseManager-to-ConfidenceScorer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2135.5,1087.9,2132.2821,1078.5917,2132.0879,1084.2452,2126.4344,1084.051,2135.5,1087.9" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="2072.93" y="1023.897">uses</text><!--MD5=[61331df7a5f32279e68532ae1fbe58be]
link ResponseManager to ClarificationManager--><path codeLine="332" d="M1653.27,979.08 C1622.82,1004.94 1592.42,1030.75 1564.64,1054.34 " fill="none" id="ResponseManager-to-ClarificationManager" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1560.56,1057.81,1570.0026,1055.0104,1564.3633,1054.5643,1564.8094,1048.9251,1560.56,1057.81" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1617.93" y="1023.897">uses</text><!--MD5=[0b66ed0c980e967bbba0b4550b8d80b9]
link ResponseManager to ConversationManager--><path codeLine="333" d="M2416.01,979.08 C2514.22,1011.32 2612.2,1043.49 2697.14,1071.37 " fill="none" id="ResponseManager-to-ConversationManager" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2701.95,1072.95,2694.6468,1066.3422,2697.1995,1071.3903,2692.1513,1073.943,2701.95,1072.95" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="2540.93" y="1023.897">uses</text><!--MD5=[bde71bbbb14417cc1f9765711132b4f4]
link VectorRetriever to ChromaDBClient--><path codeLine="335" d="M742.61,1233.82 C752.14,1279.87 764.19,1338.09 773.31,1382.2 " fill="none" id="VectorRetriever-to-ChromaDBClient" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="774.35,1387.23,776.4371,1377.6048,773.3337,1382.3344,768.6041,1379.231,774.35,1387.23" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="757.93" y="1300.897">uses</text><!--MD5=[64c3b06922415f8c8a055e0fa699cd05]
link VectorRetriever to RetrievalResult--><path codeLine="336" d="M467.01,1196.8 C309.82,1226.17 130.77,1272.23 82.93,1335 C6,1435.92 71.22,1593.38 115.77,1676.6 " fill="none" id="VectorRetriever-to-RetrievalResult" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="118.41,1681.48,117.6365,1671.6616,116.0267,1677.0845,110.6038,1675.4748,118.41,1681.48" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="83.93" y="1454.397">returns</text><!--MD5=[80d11dfe84fd0678e75080bc281067b7]
link VectorRetriever to Reranker--><path codeLine="337" d="M626.27,1233.63 C570.75,1275.34 501.89,1327.07 445.73,1369.26 " fill="none" id="VectorRetriever-to-Reranker" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="441.71,1372.28,451.31,1370.08,445.71,1369.28,446.51,1363.68,441.71,1372.28" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="546.93" y="1300.897">uses (optional)</text><!--MD5=[00e155eb9d6567e2004ee28cf50eaaee]
link Reranker to RetrievalResult--><path codeLine="338" d="M289.47,1525.7 C257.15,1573.27 216.17,1633.57 186.81,1676.76 " fill="none" id="Reranker-to-RetrievalResult" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="183.83,1681.15,192.2044,1675.9664,186.6462,1677.0186,185.5941,1671.4604,183.83,1681.15" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45" x="240.93" y="1607.897">reranks</text><!--MD5=[e6e00e98513182ba4e762f1d5c1bf451]
link LLMOrchestrator to PromptBuilder--><path codeLine="339" d="M1485.93,1825.32 C1485.93,1850.12 1485.93,1876.32 1485.93,1898.77 " fill="none" id="LLMOrchestrator-to-PromptBuilder" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1485.93,1903.8,1489.93,1894.8,1485.93,1898.8,1481.93,1894.8,1485.93,1903.8" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1486.93" y="1869.897">uses</text><!--MD5=[9bc22f2f225da60ee70768d39336fbdf]
link PromptBuilder to PromptTemplate--><path codeLine="340" d="M1485.93,2012.42 C1485.93,2035.37 1485.93,2062.21 1485.93,2085.5 " fill="none" id="PromptBuilder-to-PromptTemplate" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1485.93,2090.71,1489.93,2081.71,1485.93,2085.71,1481.93,2081.71,1485.93,2090.71" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1486.93" y="2056.897">uses</text><!--MD5=[f904c0fd1925a88514e138a579011a9a]
link ConfidenceScorer to RetrievalConfidenceScorer--><path codeLine="342" d="M2142.35,1226.36 C2102.99,1273.92 2050.86,1336.92 2012.23,1383.59 " fill="none" id="ConfidenceScorer-to-RetrievalConfidenceScorer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2009.01,1387.49,2017.8333,1383.1141,2012.2011,1383.6407,2011.6745,1378.0084,2009.01,1387.49" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="2086.93" y="1300.897">uses</text><!--MD5=[2aed14b26ed0fea4ee9ab447d70e11a6]
link ConfidenceScorer to LLMConfidenceScorer--><path codeLine="343" d="M2236.41,1226.36 C2265.22,1278.92 2304.38,1350.33 2330.36,1397.73 " fill="none" id="ConfidenceScorer-to-LLMConfidenceScorer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2332.84,1402.24,2332.0285,1392.4246,2330.4397,1397.8538,2325.0106,1396.2651,2332.84,1402.24" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="2278.93" y="1300.897">uses</text><!--MD5=[8c38c6673f608bfd4e5f3eb2b17934d0]
link ConfidenceScorer to ScoringWeights--><path codeLine="344" d="M2377.39,1226.19 C2440.99,1254.81 2511.12,1291.62 2568.93,1335 C2593.49,1353.44 2616.66,1378.56 2634.59,1400.43 " fill="none" id="ConfidenceScorer-to-ScoringWeights" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="2637.87,1404.47,2635.2991,1394.9626,2634.717,1400.5894,2629.0902,1400.0073,2637.87,1404.47" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="2523.93" y="1300.897">uses</text><!--MD5=[cbc44e94e7263a6695905688b1154828]
link ConfidenceScorer to ConfidenceResult--><path codeLine="345" d="M1983.54,1226.03 C1912.41,1253.85 1835.13,1290.18 1770.93,1335 C1753.69,1347.03 1737.22,1362.36 1722.66,1377.83 " fill="none" id="ConfidenceScorer-to-ConfidenceResult" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1719,1381.76,1728.05,1377.8745,1722.3973,1378.0915,1722.1804,1372.4388,1719,1381.76" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="44" x="1846.93" y="1300.897">returns</text><!--MD5=[409ba40509da21cbf4e2e0562adee877]
link ClarificationManager to LLMOrchestrator--><path codeLine="347" d="M1451.04,1256.24 C1456.25,1338.27 1464.11,1458.29 1471.93,1563 C1473.71,1586.92 1475.77,1612.72 1477.76,1636.8 " fill="none" id="ClarificationManager-to-LLMOrchestrator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1478.18,1641.92,1481.421,1632.6197,1477.766,1636.9372,1473.4485,1633.2821,1478.18,1641.92" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1472.93" y="1454.397">uses</text><!--MD5=[502a2ff392ca0302cab576ba5c961b9d]
link ClarificationManager to ConfidenceResult--><path codeLine="348" d="M1573.4,1256.06 C1582.61,1265.64 1591.27,1275.66 1598.93,1286 C1619.09,1313.22 1634.55,1347.32 1645.6,1377.19 " fill="none" id="ClarificationManager-to-ConfidenceResult" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1647.34,1381.95,1648.0139,1372.1242,1645.6267,1377.2527,1640.4982,1374.8655,1647.34,1381.95" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="1609.93" y="1300.897">uses</text><!--MD5=[0c78dfdbc846ef42772806f90c1472de]
link PostgreSQLHelper to IDatabase--><path codeLine="350" d="M3905.93,1563.28 C3905.93,1595.52 3905.93,1629.78 3905.93,1658.98 " fill="none" id="PostgreSQLHelper-to-IDatabase" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="3912.93,1659.25,3905.93,1679.25,3898.93,1659.25,3912.93,1659.25" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3906.93" y="1607.897">implements</text><!--MD5=[0c62438221982587647fb844543cc62b]
link ConversationManager to ConversationRepository--><path codeLine="352" d="M3160,1241.02 C3223.54,1268.78 3293.08,1301.3 3354.93,1335 C3390.36,1354.31 3428,1378.57 3459.01,1399.66 " fill="none" id="ConversationManager-to-ConversationRepository" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="3463.14,1402.48,3457.9762,1394.0934,3459.0152,1399.654,3453.4546,1400.6931,3463.14,1402.48" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="3291.93" y="1300.897">uses</text><!--MD5=[a361b7f760336b1d99710ae86baf5c64]
link ConversationManager to ConversationSummarizer--><path codeLine="353" d="M2985.87,1241.1 C2996.2,1268.83 3007.91,1300.27 3019.02,1330.12 " fill="none" id="ConversationManager-to-ConversationSummarizer" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="3020.8,1334.89,3021.4115,1325.0601,3019.0569,1330.2037,3013.9134,1327.8491,3020.8,1334.89" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="3009.93" y="1300.897">uses</text><!--MD5=[74cd7064687e6dbf204d3a1207382feb]
link DatabaseConversationRepository to ConversationRepository--><path codeLine="354" d="M3812.25,1218.79 C3749.62,1269.11 3661.22,1340.12 3599.47,1389.73 " fill="none" id="DatabaseConversationRepository-to-ConversationRepository" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="3603.57,1395.41,3583.59,1402.48,3594.8,1384.5,3603.57,1395.41" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3718.93" y="1300.897">implements</text><!--MD5=[2ed4b1c206f6169f3b14ba0c9719bcd2]
link FileConversationRepository to ConversationRepository--><path codeLine="355" d="M3526.93,1218.79 C3526.93,1266.64 3526.93,1333.22 3526.93,1382.29 " fill="none" id="FileConversationRepository-to-ConversationRepository" style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="none" points="3533.93,1382.48,3526.93,1402.48,3519.93,1382.48,3533.93,1382.48" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="3527.93" y="1300.897">implements</text><!--MD5=[b16e77f33e548c06eb83ff2fa5bbc1d7]
link DatabaseConversationRepository to PostgreSQLHelper--><path codeLine="356" d="M3891.7,1218.79 C3893.7,1250.98 3896.22,1291.64 3898.59,1329.75 " fill="none" id="DatabaseConversationRepository-to-PostgreSQLHelper" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="3898.9,1334.86,3902.3259,1325.6262,3898.5854,1329.8699,3894.3417,1326.1295,3898.9,1334.86" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="3897.93" y="1300.897">uses</text><!--MD5=[291ee78b9039ebbd66f33726140720c7]
link ConversationSummarizer to LLMOrchestrator--><path codeLine="357" d="M2788.56,1558.55 C2782.99,1560.1 2777.44,1561.59 2771.93,1563 C2424.42,1652 2011.45,1695.87 1749.05,1716.31 " fill="none" id="ConversationSummarizer-to-LLMOrchestrator" style="stroke:#A80036;stroke-width:1.0;"/><polygon fill="#A80036" points="1744.04,1716.7,1753.3217,1719.9939,1749.0251,1716.3143,1752.7047,1712.0177,1744.04,1716.7" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="27" x="2635.93" y="1607.897">uses</text><!--MD5=[30f47f92b113c1e5c0551efad60bc91f]
@startuml SchengenVisaRAGChatbotLLD2
skinparam backgroundColor white


class "main.py" as Main <<Script>> {
    + app: FastAPI
    + start()
}

class "routes.py" as Routes <<Module>> {
    + websocket_endpoint(websocket: WebSocket, user_id: str)
    + health_check() -> dict
}

class "dependencies.py" as Dependencies <<Module>> {
    + get_response_manager() -> ResponseManager
    + get_vector_retriever() -> VectorRetriever
    + get_llm_orchestrator() -> LLMOrchestrator
}

class ResponseManager {
    ' - RAG Pipeline Orchestrator
    - websocket: WebSocket
    - vector_retriever: VectorRetriever
    - llm_orchestrator: LLMOrchestrator
    - confidence_scorer: ConfidenceScorer
    - clarification_manager: ClarificationManager
    - conversation_manager: ConversationManager
    + __init__(websocket: WebSocket, vector_retriever: VectorRetriever, llm_orchestrator: LLMOrchestrator, confidence_scorer: ConfidenceScorer, clarification_manager: ClarificationManager, conversation_manager: ConversationManager)
    
    + handle_query(user_id: str, query: str, is_logged_in: bool) -> None
    ' Main entry point
    ' Orchestrates the entire RAG pipeline
    ' Handles conversation persistence based on login status
    ' Decides whether to clarify or answer

    + process_rag_pipeline(query: str) -> tuple[str, ConfidenceResult]
    ' Core RAG logic
    ' Returns: (response, confidence_result)
    ' Coordinates: retrieve → generate → score

    + send_response(response: str) -> None
    ' Send final answer via WebSocket

    + send_clarifying_question(question: str) -> None
    ' Send clarifying question via WebSocket

    - retrieve_context(query: str) -> List[RetrievalResult]
    ' Calls vector_retriever.retrieve_with_reranking()
    ' Returns List[RetrievalResult]

    - generate_response(query: str, context: List[RetrievalResult]) -> str
    ' Calls llm_orchestrator.generate_response()
    ' Returns generated answer

    - evaluate_confidence(query: str, context: List[RetrievalResult], response: str) -> ConfidenceResult
    ' Calls confidence_scorer.calculate_confidence()
    ' Returns ConfidenceResult

    ' Design Pattern: Facade Pattern
    ' ResponseManager acts as a Facade that simplifies the complex interactions between multiple subsystems.

    ' Dependencies (All Injected)
    ' VectorRetriever - Fetch top-k chunks
    ' LLMOrchestrator - Generate responses
    ' ConfidenceScorer - Evaluate answer quality
    ' ClarificationManager - Handle clarifying questions
    ' ConversationManager - Store conversation history
    ' WebSocket - Send responses to user

    ' 🔄 Complete Flow
    ' # Main RAG Pipeline Flow
    ' async def handle_query(user_id, query, is_logged_in):
    '     # 1. Retrieve context
    '     context = self.retrieve_context(query)
        
    '     # 2. Generate response
    '     response = self.generate_response(query, context)
        
    '     # 3. Evaluate confidence
    '     confidence = self.evaluate_confidence(query, context, response)
        
    '     # 4. Decide: clarify or answer?
    '     if self.clarification_manager.should_clarify(user_id, confidence.overall_confidence):
    '         # Generate clarifying question
    '         clarifying_q = self.clarification_manager.generate_clarifying_question(
    '             query, context, confidence
    '         )
    '         self.send_clarifying_question(clarifying_q)
    '     else:
    '         # Send final answer
    '         self.send_response(response)
            
    '         # Save conversation if logged in
    '         if is_logged_in:
    '             self.conversation_manager.add_message(user_id, user_msg, True)
    '             self.conversation_manager.add_message(user_id, assistant_msg, True)
}
class VectorRetriever {
    - client: ChromaDBClient
    - collection_name: str
    - top_k: int
    - reranker: Reranker
    + __init__(client: ChromaDBClient, collection_name: str, top_k: int = 3, reranker: Reranker = None)
    + retrieve(query: str) -> List[RetrievalResult]
    + retrieve_with_reranking(query: str, initial_k: int = 10) -> List[RetrievalResult]
}

class ChromaDBClient {
    - db_path: str
    - embedding_function: EmbeddingFunction
    + __init__(db_path: str, embedding_function: EmbeddingFunction)
    + get_collection(name: str) -> Collection
    + query_collection(collection_name: str, query: str, n_results: int) -> QueryResult
}

class RetrievalResult <<Pydantic>> {
    + content: str
    + metadata: dict
    + relevance_score: float
}

class Message <<Pydantic>> {
    + content: str
    
    ' Either "user" or "assistant" (follows OpenAI chat format)
    + role: str
    
    + timestamp: datetime
    + user_id: str
    
    'Optional dict for additional data (default empty dict)
    + metadata: dict = {} 
}

class Reranker {
    - model_name: str
    - model: Any
    - top_k: int
    + __init__(model_name: str = "BAAI/bge-reranker-v2-m3", top_k: int = 3)
    + rerank(query: str, results: List[RetrievalResult]) -> List[RetrievalResult]
    + calculate_rerank_scores(query: str, documents: List[str]) -> List[float]
    - load_model() -> None

    ' How It Works
    ' # Without reranking
    ' retriever = VectorRetriever(client, "flight_info", top_k=3)
    ' results = retriever.retrieve(query)  # Direct ChromaDB results

    ' # With reranking (improved accuracy)
    ' reranker = Reranker(model_name="BAAI/bge-reranker-v2-m3", top_k=3)
    ' retriever = VectorRetriever(client, "flight_info", reranker=reranker)
    ' results = retriever.retrieve_with_reranking(query, initial_k=10)
    ' # Flow: Fetch 10 → Rerank with BGE → Return top 3

    ' Benefits:
    ' Optional: Reranker is optional (dependency injection), can use without it
    ' Improved Quality: BGE reranking improves relevance of top-k chunks
    ' Two-stage retrieval: Fetch more candidates, then refine with powerful reranker
}
class LLMOrchestrator {
    - api_key: str
    - base_url: str
    - model_name: str
    - prompt_builder: PromptBuilder
    + __init__(api_key: str, model_name: str = "openai/gpt-oss-20b", prompt_builder: PromptBuilder)
    + send_message(prompt: str) -> str
    + send_message_stream(prompt: str) -> AsyncIterator[str]
    + generate_response(query: str, context: List[RetrievalResult]) -> str
    + generate_response_stream(query: str, context: List[RetrievalResult]) -> AsyncIterator[str]
}

class PromptBuilder {
    - template: PromptTemplate
    + __init__(template: PromptTemplate)
    + build_prompt(query: str, context: List[RetrievalResult]) -> str
    + format_context(results: List[RetrievalResult]) -> str
}

class PromptTemplate <<Pydantic>> {
    + system_instruction: str
    + instructions: List[str]
    + context_format: str
}

class ConversationManager {
    - repository: ConversationRepository
    - summarizer: ConversationSummarizer
    - enable_summarization: bool
    + __init__(repository: ConversationRepository, summarizer: ConversationSummarizer = None, enable_summarization: bool = False)
    + add_message(user_id: str, message: Message, is_logged_in: bool) -> None
    + get_conversation_history(user_id: str, limit: int = 20) -> List[Message]
    + get_context_for_llm(user_id: str, max_tokens: int = 2000) -> str
    + clear_conversation(user_id: str) -> None
}

interface ConversationRepository {
    + save_message(user_id: str, message: Message) -> None
    + get_messages(user_id: str, limit: int) -> List[Message]
    + delete_conversation(user_id: str) -> None
}

class DatabaseConversationRepository {
    - db_helper: PostgreSQLHelper
    + __init__(db_helper: PostgreSQLHelper)
    + save_message(user_id: str, message: Message) -> None
    + get_messages(user_id: str, limit: int) -> List[Message]
    + delete_conversation(user_id: str) -> None
}

class FileConversationRepository {
    - storage_path: str
    + __init__(storage_path: str = "./conversations")
    + save_message(user_id: str, message: Message) -> None
    + get_messages(user_id: str, limit: int) -> List[Message]
    + delete_conversation(user_id: str) -> None
}

class ConversationSummarizer {
    - llm_orchestrator: LLMOrchestrator
    - storage_summary_threshold: int
    - retrieval_summary_threshold: int
    + __init__(llm_orchestrator: LLMOrchestrator, storage_threshold: int = 50, retrieval_threshold: int = 20)
    
    ' Purpose: Compress old conversations to save DB space
    ' When: Triggered when message count > 50
    ' How: Summarize messages 1-45, keep last 5 as-is
    ' Output: Single summary Message that replaces old messages in DB
    ' Example: "User asked about visa fees (€80), flight requirements, and cancellation policy..."
    + summarize_for_storage(messages: List[Message]) -> Message

    ' Purpose: Reduce tokens when sending context to LLM
    ' When: Called by get_context_for_llm() when > 20 messages
    ' How: Summarize older messages, keep recent 5 in full detail
    ' Output: String formatted for LLM prompt
    ' Example: "Previous topics: visa fees, cancellations.\n[Recent 5 messages in full]"
    + summarize_for_retrieval(messages: List[Message], recent_count: int = 5) -> str

    ' Returns True if count > storage_threshold (50)
    + should_summarize_storage(message_count: int) -> bool

    ' Returns True if count > retrieval_threshold (20)
    + should_summarize_retrieval(message_count: int) -> bool
}


interface IDatabase {
    + disconnect()
    + fetch_data(query: str, params: tuple) -> List
    + execute_query(query: str, params: tuple, commit: bool = True) -> int
    + commit_transactions()
}

class PostgreSQLHelper {
    - db_schema: str
    - env: str
    - connection: AsyncConnection
    - cursor: AsyncCursor
    + __init__(db_schema: str, env: str = "PROD")
    + disconnect() -> None
    + fetch_data(query: str, params: tuple) -> List
    + execute_query(query: str, params: tuple, commit: bool = True) -> int
    + commit_transactions() -> None
    - __get_conn_str() -> dict
    + __enter__() -> PostgreSQLHelper
    + __exit__(exc_type, exc_value, traceback) -> None
}


class ClarificationManager {
    - llm_orchestrator: LLMOrchestrator
    - confidence_threshold: float
    - max_attempts: int
    - attempt_tracker: dict
    + __init__(llm_orchestrator: LLMOrchestrator, confidence_threshold: float = 0.7, max_attempts: int = 2)
    + should_clarify(user_id: str, confidence: float) -> bool
    + generate_clarifying_question(query: str, context: List[RetrievalResult], confidence_result: ConfidenceResult) -> str
    + increment_attempt(user_id: str) -> int
    + reset_attempts(user_id: str) -> None
    + get_attempts(user_id: str) -> int
}
class ConfidenceScorer {
    - retrieval_scorer: RetrievalConfidenceScorer
    - llm_scorer: LLMConfidenceScorer
    - weights: ScoringWeights
    + __init__(retrieval_scorer: RetrievalConfidenceScorer, llm_scorer: LLMConfidenceScorer, weights: ScoringWeights)
    + calculate_confidence(retrieval_results: List[RetrievalResult], llm_response: str, query: str) -> ConfidenceResult
    + get_overall_score(confidence_result: ConfidenceResult) -> float
}

class RetrievalConfidenceScorer {
    - min_relevance_threshold: float
    + __init__(min_relevance_threshold: float = 0.7)
    + score(retrieval_results: List[RetrievalResult]) -> float
    + calculate_avg_relevance(results: List[RetrievalResult]) -> float
    + check_coverage(results: List[RetrievalResult]) -> bool
}

class LLMConfidenceScorer {
    + score(response: str, query: str, context: List[RetrievalResult]) -> float
    + check_response_quality(response: str) -> float
    + check_grounding(response: str, context: List[RetrievalResult]) -> float
}

class ConfidenceResult <<Pydantic>> {
    + retrieval_confidence: float
    + llm_confidence: float
    + overall_confidence: float
    + is_confident: bool
    + confidence_breakdown: dict
}

class ScoringWeights <<Pydantic>> {
    + retrieval_weight: float = 0.4
    + llm_weight: float = 0.6
}
class DocumentEncoder {
    + encode(documents: List[str]) -> List[str]
}

Main - -> Routes : includes
Routes - -> Dependencies : uses
Dependencies - -> ResponseManager : creates
Dependencies - -> VectorRetriever : creates
Dependencies - -> LLMOrchestrator : creates
Dependencies - -> ConfidenceScorer : creates
Dependencies - -> ClarificationManager : creates
Dependencies - -> ConversationManager : creates

ResponseManager - -> VectorRetriever : uses
ResponseManager - -> LLMOrchestrator : uses
ResponseManager - -> ConfidenceScorer : uses
ResponseManager - -> ClarificationManager : uses
ResponseManager - -> ConversationManager : uses

VectorRetriever - -> ChromaDBClient : uses
VectorRetriever - -> RetrievalResult : returns
VectorRetriever - -> Reranker : uses (optional)
Reranker - -> RetrievalResult : reranks
LLMOrchestrator - -> PromptBuilder : uses
PromptBuilder - -> PromptTemplate : uses

ConfidenceScorer - -> RetrievalConfidenceScorer : uses
ConfidenceScorer - -> LLMConfidenceScorer : uses
ConfidenceScorer - -> ScoringWeights : uses
ConfidenceScorer - -> ConfidenceResult : returns

ClarificationManager - -> LLMOrchestrator : uses
ClarificationManager - -> ConfidenceResult : uses

PostgreSQLHelper ..|> IDatabase : implements

ConversationManager - -> ConversationRepository : uses
ConversationManager - -> ConversationSummarizer : uses
DatabaseConversationRepository ..|> ConversationRepository : implements
FileConversationRepository ..|> ConversationRepository : implements
DatabaseConversationRepository - -> PostgreSQLHelper : uses
ConversationSummarizer - -> LLMOrchestrator : uses 

@enduml

@startuml SchengenVisaRAGChatbotLLD2
skinparam backgroundColor white


class "main.py" as Main <<Script>> {
    + app: FastAPI
    + start()
}

class "routes.py" as Routes <<Module>> {
    + websocket_endpoint(websocket: WebSocket, user_id: str)
    + health_check() -> dict
}

class "dependencies.py" as Dependencies <<Module>> {
    + get_response_manager() -> ResponseManager
    + get_vector_retriever() -> VectorRetriever
    + get_llm_orchestrator() -> LLMOrchestrator
}

class ResponseManager {
    - websocket: WebSocket
    - vector_retriever: VectorRetriever
    - llm_orchestrator: LLMOrchestrator
    - confidence_scorer: ConfidenceScorer
    - clarification_manager: ClarificationManager
    - conversation_manager: ConversationManager
    + __init__(websocket: WebSocket, vector_retriever: VectorRetriever, llm_orchestrator: LLMOrchestrator, confidence_scorer: ConfidenceScorer, clarification_manager: ClarificationManager, conversation_manager: ConversationManager)
    
    + handle_query(user_id: str, query: str, is_logged_in: bool) -> None

    + process_rag_pipeline(query: str) -> tuple[str, ConfidenceResult]

    + send_response(response: str) -> None

    + send_clarifying_question(question: str) -> None

    - retrieve_context(query: str) -> List[RetrievalResult]

    - generate_response(query: str, context: List[RetrievalResult]) -> str

    - evaluate_confidence(query: str, context: List[RetrievalResult], response: str) -> ConfidenceResult



        
        
        
            
}
class VectorRetriever {
    - client: ChromaDBClient
    - collection_name: str
    - top_k: int
    - reranker: Reranker
    + __init__(client: ChromaDBClient, collection_name: str, top_k: int = 3, reranker: Reranker = None)
    + retrieve(query: str) -> List[RetrievalResult]
    + retrieve_with_reranking(query: str, initial_k: int = 10) -> List[RetrievalResult]
}

class ChromaDBClient {
    - db_path: str
    - embedding_function: EmbeddingFunction
    + __init__(db_path: str, embedding_function: EmbeddingFunction)
    + get_collection(name: str) -> Collection
    + query_collection(collection_name: str, query: str, n_results: int) -> QueryResult
}

class RetrievalResult <<Pydantic>> {
    + content: str
    + metadata: dict
    + relevance_score: float
}

class Message <<Pydantic>> {
    + content: str
    
    + role: str
    
    + timestamp: datetime
    + user_id: str
    
    + metadata: dict = {} 
}

class Reranker {
    - model_name: str
    - model: Any
    - top_k: int
    + __init__(model_name: str = "BAAI/bge-reranker-v2-m3", top_k: int = 3)
    + rerank(query: str, results: List[RetrievalResult]) -> List[RetrievalResult]
    + calculate_rerank_scores(query: str, documents: List[str]) -> List[float]
    - load_model() -> None



}
class LLMOrchestrator {
    - api_key: str
    - base_url: str
    - model_name: str
    - prompt_builder: PromptBuilder
    + __init__(api_key: str, model_name: str = "openai/gpt-oss-20b", prompt_builder: PromptBuilder)
    + send_message(prompt: str) -> str
    + send_message_stream(prompt: str) -> AsyncIterator[str]
    + generate_response(query: str, context: List[RetrievalResult]) -> str
    + generate_response_stream(query: str, context: List[RetrievalResult]) -> AsyncIterator[str]
}

class PromptBuilder {
    - template: PromptTemplate
    + __init__(template: PromptTemplate)
    + build_prompt(query: str, context: List[RetrievalResult]) -> str
    + format_context(results: List[RetrievalResult]) -> str
}

class PromptTemplate <<Pydantic>> {
    + system_instruction: str
    + instructions: List[str]
    + context_format: str
}

class ConversationManager {
    - repository: ConversationRepository
    - summarizer: ConversationSummarizer
    - enable_summarization: bool
    + __init__(repository: ConversationRepository, summarizer: ConversationSummarizer = None, enable_summarization: bool = False)
    + add_message(user_id: str, message: Message, is_logged_in: bool) -> None
    + get_conversation_history(user_id: str, limit: int = 20) -> List[Message]
    + get_context_for_llm(user_id: str, max_tokens: int = 2000) -> str
    + clear_conversation(user_id: str) -> None
}

interface ConversationRepository {
    + save_message(user_id: str, message: Message) -> None
    + get_messages(user_id: str, limit: int) -> List[Message]
    + delete_conversation(user_id: str) -> None
}

class DatabaseConversationRepository {
    - db_helper: PostgreSQLHelper
    + __init__(db_helper: PostgreSQLHelper)
    + save_message(user_id: str, message: Message) -> None
    + get_messages(user_id: str, limit: int) -> List[Message]
    + delete_conversation(user_id: str) -> None
}

class FileConversationRepository {
    - storage_path: str
    + __init__(storage_path: str = "./conversations")
    + save_message(user_id: str, message: Message) -> None
    + get_messages(user_id: str, limit: int) -> List[Message]
    + delete_conversation(user_id: str) -> None
}

class ConversationSummarizer {
    - llm_orchestrator: LLMOrchestrator
    - storage_summary_threshold: int
    - retrieval_summary_threshold: int
    + __init__(llm_orchestrator: LLMOrchestrator, storage_threshold: int = 50, retrieval_threshold: int = 20)
    
    + summarize_for_storage(messages: List[Message]) -> Message

    + summarize_for_retrieval(messages: List[Message], recent_count: int = 5) -> str

    + should_summarize_storage(message_count: int) -> bool

    + should_summarize_retrieval(message_count: int) -> bool
}


interface IDatabase {
    + disconnect()
    + fetch_data(query: str, params: tuple) -> List
    + execute_query(query: str, params: tuple, commit: bool = True) -> int
    + commit_transactions()
}

class PostgreSQLHelper {
    - db_schema: str
    - env: str
    - connection: AsyncConnection
    - cursor: AsyncCursor
    + __init__(db_schema: str, env: str = "PROD")
    + disconnect() -> None
    + fetch_data(query: str, params: tuple) -> List
    + execute_query(query: str, params: tuple, commit: bool = True) -> int
    + commit_transactions() -> None
    - __get_conn_str() -> dict
    + __enter__() -> PostgreSQLHelper
    + __exit__(exc_type, exc_value, traceback) -> None
}


class ClarificationManager {
    - llm_orchestrator: LLMOrchestrator
    - confidence_threshold: float
    - max_attempts: int
    - attempt_tracker: dict
    + __init__(llm_orchestrator: LLMOrchestrator, confidence_threshold: float = 0.7, max_attempts: int = 2)
    + should_clarify(user_id: str, confidence: float) -> bool
    + generate_clarifying_question(query: str, context: List[RetrievalResult], confidence_result: ConfidenceResult) -> str
    + increment_attempt(user_id: str) -> int
    + reset_attempts(user_id: str) -> None
    + get_attempts(user_id: str) -> int
}
class ConfidenceScorer {
    - retrieval_scorer: RetrievalConfidenceScorer
    - llm_scorer: LLMConfidenceScorer
    - weights: ScoringWeights
    + __init__(retrieval_scorer: RetrievalConfidenceScorer, llm_scorer: LLMConfidenceScorer, weights: ScoringWeights)
    + calculate_confidence(retrieval_results: List[RetrievalResult], llm_response: str, query: str) -> ConfidenceResult
    + get_overall_score(confidence_result: ConfidenceResult) -> float
}

class RetrievalConfidenceScorer {
    - min_relevance_threshold: float
    + __init__(min_relevance_threshold: float = 0.7)
    + score(retrieval_results: List[RetrievalResult]) -> float
    + calculate_avg_relevance(results: List[RetrievalResult]) -> float
    + check_coverage(results: List[RetrievalResult]) -> bool
}

class LLMConfidenceScorer {
    + score(response: str, query: str, context: List[RetrievalResult]) -> float
    + check_response_quality(response: str) -> float
    + check_grounding(response: str, context: List[RetrievalResult]) -> float
}

class ConfidenceResult <<Pydantic>> {
    + retrieval_confidence: float
    + llm_confidence: float
    + overall_confidence: float
    + is_confident: bool
    + confidence_breakdown: dict
}

class ScoringWeights <<Pydantic>> {
    + retrieval_weight: float = 0.4
    + llm_weight: float = 0.6
}
class DocumentEncoder {
    + encode(documents: List[str]) -> List[str]
}

Main - -> Routes : includes
Routes - -> Dependencies : uses
Dependencies - -> ResponseManager : creates
Dependencies - -> VectorRetriever : creates
Dependencies - -> LLMOrchestrator : creates
Dependencies - -> ConfidenceScorer : creates
Dependencies - -> ClarificationManager : creates
Dependencies - -> ConversationManager : creates

ResponseManager - -> VectorRetriever : uses
ResponseManager - -> LLMOrchestrator : uses
ResponseManager - -> ConfidenceScorer : uses
ResponseManager - -> ClarificationManager : uses
ResponseManager - -> ConversationManager : uses

VectorRetriever - -> ChromaDBClient : uses
VectorRetriever - -> RetrievalResult : returns
VectorRetriever - -> Reranker : uses (optional)
Reranker - -> RetrievalResult : reranks
LLMOrchestrator - -> PromptBuilder : uses
PromptBuilder - -> PromptTemplate : uses

ConfidenceScorer - -> RetrievalConfidenceScorer : uses
ConfidenceScorer - -> LLMConfidenceScorer : uses
ConfidenceScorer - -> ScoringWeights : uses
ConfidenceScorer - -> ConfidenceResult : returns

ClarificationManager - -> LLMOrchestrator : uses
ClarificationManager - -> ConfidenceResult : uses

PostgreSQLHelper ..|> IDatabase : implements

ConversationManager - -> ConversationRepository : uses
ConversationManager - -> ConversationSummarizer : uses
DatabaseConversationRepository ..|> ConversationRepository : implements
FileConversationRepository ..|> ConversationRepository : implements
DatabaseConversationRepository - -> PostgreSQLHelper : uses
ConversationSummarizer - -> LLMOrchestrator : uses 

@enduml

PlantUML version 1.2021.00(Sun Jan 10 15:55:05 IST 2021)
(MIT source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>